<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: clock.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: clock.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const ticker = require("./ticker");
const event = require("./event").init();
const Clock = Object.create(event);
const MAX_FPS = 60;
const noop = () => {};

/**
 * init - Initalizes the clock with correct properties.
 * @param  {Object} opts
 * @param  {Number} opts.fps The fps you want the clock to tick at.
 * @return {Clock}
 */
Clock.init = function initClock(opts={}) {
  opts = Object.assign({
    fps: MAX_FPS,
  }, opts);

  this.slaves = [];
  this.parent = event;

  // Zero based frame count.
  this.index = -1;

  // Save a reference to the animation frame so we can cancel it
  this.rAF = 0;

  // Time properties
  this.startTime;
  this.lastTime;
  this.stopTime;
  this.timeSinceStart = 0;

  // The maximum FPS the browser can deliver is 60.
  this.fps = opts.fps > MAX_FPS ?
    MAX_FPS :
    (opts.fps || MAX_FPS);

  return this;
};

/**
 * start - Starts the clock with starting time properties.
 * @param  {Number} fps The fps you want the clock to tick at.
 * @return {Clock}
 */
Clock.start = function start() {
  if (this.fps > 60) {
    throw new Error("The given fps is too high");
  }

  if (+this.fps === NaN) {
    throw new Error("The given fps is not valid");
  }

  this.fps = 1000 / this.fps;
  this.startTime = performance.now();
  this.lastTime = this.startTime;

  // Start ticking
  this.loop(this.startTime);
  return this;
};

/**
 * tick
 * @param  {Number} newTime A value in ms that is equal to the current time.
 * @return {Clock}
 */
Clock.loop = function loop(newTime) {
  this.rAF = requestAnimationFrame(loop.bind(this));

  let delta = newTime - this.lastTime;
  this.timeSinceStart = newTime - this.startTime;

  if (delta > this.fps) {
    this.index++;

    this.whipSlaves({
      newTime,
      delta,
      index: this.index,
      lastTime: this.lastTime,
      clockStart: this.startTime,
      timeSinceStart: this.timeSinceStart,
    });

    this.lastTime = newTime - (delta % this.fps);
  }

  this.emit("render");

  return this;
};

/**
 * stop - Stop the clock and call the last tick if needed.
 * @return {Clock}
 */
Clock.stop = function stopClock() {
  cancelAnimationFrame(this.rAF);

  // Record when we stopped.
  this.stopTime = performance.now();
  this.timeSinceStart += this.stopTime - this.startTime;
  this.clearSlaves();

  this.emit("stopped");
  return this;
};

/**
 * whipSlaves - Run all slaves in sequence and pass in
 * the given state of the clock.
 * @param  {Object} state
 * @return {Clock}
 */
Clock.whipSlaves = function whipSlaves(state) {
  if (!this.slaves.length) return;

  this.slaves.forEach((slave, index) => {
    slave.nudge(state);
  });

  this.emit("tick");
  return this;
};

Clock.createSlave = function createSlave(opts) {
  if (!opts) {
    throw new Error("Please provide a options object");
  }

  const {id, duration} = opts;
  const timeStamp = performance.now();

  const slave = Object.create(ticker)
    .init({timeStamp, id, duration});

  if (id) {
    this.slaves.push(slave);
    return slave;
  }

  slave.id = this.slaves.push(slave);
  return slave;
};

Clock.removeSlave = function removeSlave(id) {
  this.slaves = this.slaves.filter((slave) => {
    if (slave.id !== id) {
      return true;
    }
    slave.removeAllListeners();
    return false;
  });
};

Clock.clearSlaves = function clearSlaves() {
  if (this.slaves.length) this.slaves = [];
};

Clock.reset = function() {
  this.stop();
  this.clearSlaves();
  this.removeAllListeners();
  this.rAF = 0;
};

Clock.removeAllSlaves = Clock.clearSlaves;

module.exports = Clock;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Particle.html">Particle</a></li><li><a href="Shapes.html">Shapes</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Event">Event</a></li><li><a href="global.html#extend">extend</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Mon Aug 07 2017 11:41:57 GMT+1000 (AEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
